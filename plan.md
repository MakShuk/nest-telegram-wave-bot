# План рефакторинга архитектуры Telegram бота

## Этап 1: Критические исправления (Приоритет: ВЫСОКИЙ)

### 1.1 Исправление main.ts - graceful shutdown
- **Файл**: `src/main.ts`
- **Задача**: Добавить graceful shutdown для приложения
- **Время**: 30 минут

#### Анализ: `app.listen()` vs `app.init()`

**АРГУМЕНТЫ ЗА `app.listen(port)`:**
- ✅ У вас есть HTTP API контроллеры ([`AppController`](src/app.controller.ts:16) с `/status` и `/send-notification`)
- ✅ Используется Swagger ([`@ApiTags`](src/app.controller.ts:5), [`@ApiOperation`](src/app.controller.ts:10))
- ✅ Возможность мониторинга через HTTP endpoints
- ✅ Стандартный подход для веб-приложений NestJS
- ✅ Позволяет внешним системам взаимодействовать с ботом

**АРГУМЕНТЫ ПРОТИВ `app.listen(port)`:**
- ❌ Telegram бот может работать только на webhooks/polling без HTTP сервера
- ❌ Дополнительная поверхность атаки (открытый порт)
- ❌ Потребление дополнительных ресурсов

**ВЫВОД:** Поскольку у вас уже есть HTTP API для отправки уведомлений и статуса, **следует использовать `app.listen()`**

**Изменения**:
  - Заменить `app.init()` на `app.listen(port)`
  - Добавить обработчики SIGTERM/SIGINT для graceful shutdown
  - Добавить метод для корректного завершения бота и HTTP сервера
  - Добавить конфигурацию порта через переменные окружения

### 1.2 Исправление дублирования TelegramActionsService
- **Файл**: `src/app.module.ts`
- **Задача**: Удалить дублирование сервиса в providers
- **Время**: 10 минут
- **Изменения**:
  - Удалить `TelegramActionsService` из providers массива
  - Проверить экспорт из `TelegramActionsModule`

### 1.3 Исправление bot.launch() в TelegramService
- **Файл**: `src/configs/telegram.config.ts`
- **Задача**: Добавить await для bot.launch() и graceful shutdown
- **Время**: 20 минут
- **Изменения**:
  - Добавить `await` перед `bot.launch()`
  - Создать метод `stopBot()` для graceful shutdown
  - Добавить обработку сигналов завершения

## Этап 2: Улучшение конфигурации (Приоритет: ВЫСОКИЙ)

### 2.1 Конфигурация NotificationService
- **Файл**: `src/notification/notification.service.ts`
- **Задача**: Вынести хардкод в конфигурацию
- **Время**: 45 минут
- **Изменения**:
  - Создать интерфейс `NotificationConfig`
  - Добавить переменные окружения для времени уведомлений
  - Сделать метод `getHoursUntilTarget()` более гибким
  - Добавить конфигурируемые интервалы

### 2.2 Обновление config.schema.ts
- **Файл**: `src/configs/config/config.schema.ts`
- **Задача**: Добавить валидацию новых переменных
- **Время**: 20 минут
- **Изменения**:
  - Добавить схему для PORT
  - Добавить схему для NOTIFICATION_TARGET_HOUR
  - Добавить схему для DEFAULT_NOTIFICATION_INTERVAL

### 2.3 Обновление .env файлов
- **Файлы**: `envs/.env.example`, `envs/.env.development`
- **Задача**: Добавить новые переменные окружения
- **Время**: 15 минут
- **Изменения**:
  - Добавить PORT=3000
  - Добавить NOTIFICATION_TARGET_HOUR=18
  - Добавить DEFAULT_NOTIFICATION_INTERVAL=10

## Этап 3: Улучшение типизации (Приоритет: СРЕДНИЙ)

### 3.1 Улучшение IntervalTaskService
- **Файл**: `src/services/interval-task.service.ts`
- **Задача**: Улучшить типизацию и добавить валидацию
- **Время**: 40 минут
- **Изменения**:
  - Заменить `Promise<any>` на `Promise<void>`
  - Добавить валидацию cron выражений
  - Создать интерфейс `TaskConfig`
  - Добавить enum для стандартных интервалов

### 3.2 Создание интерфейсов для сервисов
- **Файлы**: `src/interfaces/` (новая папка)
- **Задача**: Создать интерфейсы для всех сервисов
- **Время**: 60 минут
- **Изменения**:
  - `ITelegramService.ts` - интерфейс для Telegram сервиса
  - `INotificationService.ts` - интерфейс для уведомлений
  - `IIntervalTaskService.ts` - интерфейс для задач
  - `IBotLifecycle.ts` - интерфейс для lifecycle управления

## Этап 4: Рефакторинг архитектуры (Приоритет: СРЕДНИЙ)

### 4.1 Разделение TelegramService
- **Файлы**: 
  - `src/telegram/telegram.service.ts` (новый)
  - `src/telegram/telegram-middleware.service.ts` (новый)
  - `src/telegram/telegram-lifecycle.service.ts` (новый)
- **Задача**: Разделить ответственности TelegramService
- **Время**: 90 минут
- **Изменения**:
  - Выделить middleware в отдельный сервис
  - Выделить lifecycle управление
  - Создать базовый TelegramService только для создания бота

### 4.2 Создание NotificationConfigService
- **Файл**: `src/notification/notification-config.service.ts`
- **Задача**: Выделить логику конфигурации уведомлений
- **Время**: 45 минут
- **Изменения**:
  - Создать сервис для управления конфигурацией уведомлений
  - Перенести методы расчета времени
  - Добавить методы для различных типов уведомлений

### 4.3 Создание TaskFactory
- **Файл**: `src/services/task.factory.ts`
- **Задача**: Применить Factory Pattern для создания задач
- **Время**: 60 минут
- **Изменения**:
  - Создать фабрику для создания различных типов задач
  - Добавить предустановленные конфигурации задач
  - Упростить использование IntervalTaskService

## Этап 5: Добавление новых возможностей (Приоритет: НИЗКИЙ)

### 5.1 Health Check контроллер
- **Файл**: `src/health/health.controller.ts`
- **Задача**: Добавить мониторинг состояния приложения
- **Время**: 45 минут
- **Изменения**:
  - Создать HealthModule
  - Добавить эндпоинт `/health`
  - Проверять состояние бота и задач
  - Добавить метрики времени работы

### 5.2 Логирование и мониторинг
- **Файл**: `src/common/logging.service.ts`
- **Задача**: Унифицировать логирование
- **Время**: 60 минут
- **Изменения**:
  - Создать централизованный сервис логирования
  - Добавить структурированные логи
  - Добавить метрики производительности
  - Создать interceptor для логирования запросов

### 5.3 Rate Limiting для команд
- **Файл**: `src/telegram/rate-limit.guard.ts`
- **Задача**: Добавить защиту от спама команд
- **Время**: 75 минут
- **Изменения**:
  - Создать Guard для rate limiting
  - Добавить Redis или in-memory хранилище для счетчиков
  - Настроить лимиты для разных типов команд
  - Добавить уведомления о превышении лимитов

## Этап 6: Паттерны и улучшения (Приоритет: НИЗКИЙ)

### 6.1 Command Pattern для Telegram команд
- **Папка**: `src/commands/`
- **Задача**: Реализовать Command Pattern
- **Время**: 120 минут
- **Изменения**:
  - Создать базовый класс `TelegramCommand`
  - Создать конкретные команды (StartCommand, HelpCommand, etc.)
  - Добавить CommandRegistry для управления командами
  - Интегрировать с TelegramActionsService

### 6.2 Strategy Pattern для уведомлений
- **Папка**: `src/notification/strategies/`
- **Задача**: Реализовать разные стратегии уведомлений
- **Время**: 90 минут
- **Изменения**:
  - Создать интерфейс `NotificationStrategy`
  - Реализовать RandomNotificationStrategy
  - Реализовать ScheduledNotificationStrategy
  - Добавить WeightedNotificationStrategy

### 6.3 Observer Pattern для событий бота
- **Папка**: `src/events/`
- **Задача**: Добавить систему событий
- **Время**: 105 минут
- **Изменения**:
  - Создать EventEmitter сервис
  - Добавить события (MessageReceived, CommandExecuted, etc.)
  - Создать слушатели для логирования и аналитики
  - Интегрировать с существующими сервисами

## Этап 7: Тестирование и документация (Приоритет: СРЕДНИЙ)

### 7.1 Unit тесты для сервисов
- **Папка**: `src/**/*.spec.ts`
- **Задача**: Добавить тесты для всех сервисов
- **Время**: 180 минут
- **Изменения**:
  - Тесты для TelegramService
  - Тесты для NotificationService
  - Тесты для IntervalTaskService
  - Моки для внешних зависимостей

### 7.2 E2E тесты
- **Папка**: `test/`
- **Задача**: Добавить интеграционные тесты
- **Время**: 120 минут
- **Изменения**:
  - Тесты для Telegram команд
  - Тесты для уведомлений
  - Тесты для health check

### 7.3 Документация API
- **Файл**: `docs/api.md`
- **Задача**: Создать документацию
- **Время**: 60 минут
- **Изменения**:
  - Документация по архитектуре
  - Описание конфигурации
  - Примеры использования

## Общее время выполнения: ~20 часов

### Порядок выполнения:
1. **Неделя 1**: Этапы 1-2 (критические исправления и конфигурация)
2. **Неделя 2**: Этапы 3-4 (типизация и рефакторинг)
3. **Неделя 3**: Этапы 5-6 (новые возможности и паттерны)
4. **Неделя 4**: Этап 7 (тестирование и документация)

### Метрики успеха:
- ✅ Отсутствие критических ошибок
- ✅ Покрытие тестами >80%
- ✅ Время отклика health check <100ms
- ✅ Graceful shutdown за <5 секунд
- ✅ Конфигурируемость всех параметров